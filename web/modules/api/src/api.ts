import { Api, RequestParams } from "../vendor/api"

const API_PATH = "/api--v0"

class WikijumpAPIInstance extends Api<void> {
  // private properties have _ as a prefix to prevent conflicting with any
  // autogenerated API methods

  /** Current CSRF token. */
  private declare _CSRF: string

  /** @param headers - Extra headers to send with every request. */
  constructor(headers: Record<string, string> = {}) {
    super({
      baseUrl: API_PATH,
      baseApiParams: {
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json",
          ...headers
        },
        secure: true,
        format: "json"
      },
      securityWorker: (): RequestParams => {
        const csrf = this._CSRF
        const xsrf = getCSRFCookie()
        if (xsrf) return { headers: { "X-CSRF-TOKEN": csrf, "X-XSRF-TOKEN": xsrf } }
        else return { headers: { "X-CSRF-TOKEN": csrf } }
      }
    })

    this._CSRF = getCSRFMeta()

    // authLogin is special in that it regenerates your session.
    // this invalidates your old CSRF token, so we need to update it,
    // which means overriding the old authLogin method

    const login = this.authLogin.bind(this)

    this.authLogin = async (data, requestParams) => {
      const { csrf } = await login(data, requestParams)
      this._CSRF = csrf
      return { csrf }
    }
  }
}

/** Wikijump API. */
export const WikijumpAPI = new WikijumpAPIInstance()

/**
 * Retrieves the CSRF token from the `<meta name="csrf-token" ...>` tag in
 * the `<head>`. This should always be present, so this function throws if
 * that element can't be found.
 */
function getCSRFMeta() {
  const meta = document.head.querySelector("meta[name=csrf-token]")
  if (!meta) throw new Error("No CSRF meta tag found")
  return meta.getAttribute("content")!
}

/** Retrieves the CSRF token from the `XSRF-TOKEN` cookie, if it exists. */
function getCSRFCookie() {
  const value = document.cookie
    .split(/;\s*/)
    .find(c => c.startsWith("XSRF-TOKEN="))
    ?.split("=")[1]
  return value
}
